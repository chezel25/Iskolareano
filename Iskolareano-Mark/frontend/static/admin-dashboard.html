<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>

<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: #eef2ff;
  color: #111827;
}
.container {
  max-width: 1200px;
  margin: 30px auto;
  padding: 20px;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}
.logout {
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  background: white;
  cursor: pointer;
}
.nav {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 30px;
}
.nav-card {
  background: white;
  border-radius: 16px;
  padding: 18px;
  cursor: pointer;
  box-shadow: 0 6px 15px rgba(0,0,0,0.06);
}
.card {
  background: white;
  border-radius: 18px;
  padding: 22px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
input, select, button {
  padding: 8px;
  margin: 6px 0;
}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h1>Admin Dashboard <span id="roleLabel"></span></h1>
    <button class="logout" onclick="logout()">Logout</button>
  </div>

  <div class="nav">
    <div class="nav-card" data-roles="admin,mswd,examiner,staff">Applicants</div>
    <div class="nav-card" data-roles="admin,mswd">Scholars</div>
    <div class="nav-card" data-roles="admin,mswd,examiner">Announcements</div>
    <div class="nav-card" data-roles="admin,mswd">Create Scholar</div>
    <div class="nav-card" data-roles="admin" onclick="showCreateStaffForm()">Create Account</div>
    <div class="nav-card" data-roles="admin" onclick="showPendingStaff()">Pending Staff</div>
  </div>

  <div id="content" class="card">
    Select an option above.
  </div>
</div>

<script>
/* ================= AUTH ================= */
const staffRole = localStorage.getItem('staff_role');
if (!staffRole) window.location.href = 'admin-login.html';

document.getElementById('roleLabel').textContent = `(${staffRole.toUpperCase()})`;

document.querySelectorAll('.nav-card').forEach(card => {
  if (!card.dataset.roles.split(',').includes(staffRole)) {
    card.style.display = 'none';
  }
});

function logout() {
  localStorage.removeItem('staff_role');
  window.location.href = 'admin-login.html';
}

const authHeaders = () => ({
  'Content-Type': 'application/json',
  'x-role': localStorage.getItem('staff_role')
});

/* ================= CREATE STAFF ================= */
function showCreateStaffForm() {
  document.getElementById('content').innerHTML = `
    <h3>Create Staff Account</h3>
    <form id="createStaffForm">
      <input id="first_name" placeholder="First Name" required><br>
      <input id="last_name" placeholder="Last Name" required><br>
      <input id="email" type="email" placeholder="Email" required><br>

      <select id="staff_role_select" required>
        <option value="">Select role</option>
        <option value="admin">Admin</option>
        <option value="mswd">MSWD</option>
        <option value="examiner">Examiner</option>
        <option value="staff">Staff</option>
      </select><br><br>

      <button type="submit">Create Account</button>
    </form>
  `;

  document.getElementById('createStaffForm').addEventListener('submit', async e => {
    e.preventDefault();

    const payload = {
      first_name: document.getElementById('first_name').value.trim(),
      last_name: document.getElementById('last_name').value.trim(),
      email: document.getElementById('email').value.trim(),
      role: document.getElementById('staff_role_select').value
    };

    const res = await fetch('http://localhost:5000/api/staff/create', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error);

    alert('Staff account created.');
    showPendingStaff();
  });
}

/* ================= PENDING STAFF REQUESTS ================= */
async function showPendingStaff() {
  const res = await fetch('http://localhost:5000/api/staff/requests', {
    headers: authHeaders()
  });

  const staff = await res.json();
  if (!res.ok) return alert(staff.error);

  let html = `<h3>Pending Staff Requests</h3>
  <table border="1" width="100%">
    <tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>`;

  staff.forEach(s => {
    html += `
      <tr>
        <td>${s.first_name} ${s.last_name}</td>
        <td>${s.email}</td>
        <td>${s.role.toUpperCase()}</td>
        <td>
          <button onclick="approveStaff('${s.id}')">Approve</button>
          <button onclick="rejectStaff('${s.id}')">Reject</button>
        </td>
      </tr>`;
  });

  html += `</table>`;
  document.getElementById('content').innerHTML = html;
}

async function approveStaff(id) {
  const res = await fetch(`http://localhost:5000/api/staff/requests/${id}/approve`, {
    method: 'POST',
    headers: authHeaders()
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error);
  showPendingStaff();
}

async function rejectStaff(id) {
  const res = await fetch(`http://localhost:5000/api/staff/requests/${id}/reject`, {
    method: 'POST',
    headers: authHeaders()
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error);
  showPendingStaff();
}
</script>
</body>
</html>
