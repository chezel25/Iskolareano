<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Applicant Dashboard</title>

<style>
body {
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:#eef4ff;
}

.container {
  max-width:900px;
  margin:30px auto;
  padding:20px;
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.header button {
  padding:8px 12px;
  border:1px solid #ddd;
  background:white;
  border-radius:8px;
  cursor:pointer;
}

.card {
  background:white;
  border-radius:16px;
  padding:20px;
  margin-top:20px;
}

.status-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.badge {
  background:#fde68a;
  color:#92400e;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}

.progress-wrapper {
  margin-top:15px;
}

.progress-label {
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin-bottom:6px;
}

.progress-bar {
  height:8px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
}

#progressFill {
  height:100%;
  width:0%;
  background:#111827;
  transition:width 0.4s ease;
}

/* TRACKER */
.tracker {
  list-style:none;
  padding:0;
}

.tracker li {
  display:flex;
  gap:12px;
  margin-bottom:18px;
  opacity:0.35;
  transition:0.3s;
}

.tracker li.active {
  opacity:1;
}

.tracker li.current {
  opacity:1;
}

.tracker li.completed {
  opacity:1;
}

.tracker li.completed .dot {
  background:#10b981;
  border-color:#10b981;
}

.tracker li.current .dot {
  background:#111827;
  border-color:#111827;
}

.dot {
  width:16px;
  height:16px;
  border-radius:50%;
  border:2px solid #9ca3af;
  margin-top:4px;
  flex-shrink:0;
}

.active .dot {
  background:#111827;
  border-color:#111827;
}

.muted {
  color:#6b7280;
  font-size:14px;
}

/* REQUIREMENTS */
#requirementsSection {
  display:none;
}

.req-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border:1px solid #e5e7eb;
  border-radius:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}

.req-item.done {
  background:#ecfdf5;
  border-color:#10b981;
}

.req-item.done strong {
  color:#065f46;
}

.req-buttons {
  display:flex;
  gap:8px;
}

.req-buttons button {
  padding:6px 12px;
  border:1px solid #ddd;
  background:white;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
}

#submitBtn {
  margin-top:15px;
  padding:10px 20px;
  background:#111827;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

#submitBtn:disabled {
  background:#9ca3af;
  cursor:not-allowed;
}

/* POPUP */
#popup {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
}

.popup-card {
  background:white;
  padding:30px;
  border-radius:16px;
  text-align:center;
  max-width:400px;
}

.popup-card h2 {
  margin-bottom:10px;
}

.popup-card button {
  margin-top:15px;
  padding:10px 20px;
  background:#111827;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div>
      <h1 id="welcomeText">Welcome!</h1>
      <p>Applicant Dashboard</p>
    </div>
    <div>
      <button onclick="toggleRequirements()">Requirements</button>
      <button onclick="location.href='login.html'">Logout</button>
    </div>
  </div>

  <!-- STATUS -->
  <div class="card">
    <div class="status-header">
      <h3>Application Status</h3>
      <span id="statusBadge" class="badge">Upload required documents</span>
    </div>

    <div class="progress-wrapper">
      <div class="progress-label">
        <span>Overall Progress</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div id="progressFill"></div>
      </div>
    </div>
  </div>

  <!-- TRACKER -->
  <div class="card" id="trackerSection">
    <h3>Application Tracker</h3>
    <p class="muted">Track your progress</p>

    <ul class="tracker">
      <li id="tracker-requirements_pending">
        <span class="dot"></span>
        <div>
          <strong>Requirements Pending</strong><br>
          <small class="muted">Upload required documents</small>
        </div>
      </li>

      <li id="tracker-requirements_review">
        <span class="dot"></span>
        <div>
          <strong>Requirements Under Review</strong><br>
          <small class="muted">Admin is reviewing your documents</small>
        </div>
      </li>

      <li id="tracker-requirements_approved">
        <span class="dot"></span>
        <div>
          <strong>Requirements Approved</strong><br>
          <small class="muted">Ready for examination</small>
        </div>
      </li>

      <li id="tracker-exam_pending">
        <span class="dot"></span>
        <div>
          <strong>Examination</strong><br>
          <small class="muted">passed the exam</small>
        </div>
      </li>

      <li id="tracker-mswd_pending">
        <span class="dot"></span>
        <div>
          <strong>MSWD Evaluation</strong><br>
          <small class="muted">Final evaluation</small>
        </div>
      </li>

      <li id="tracker-scholar">
        <span class="dot"></span>
        <div>
          <strong>Scholar Status</strong><br>
          <small class="muted">Congratulations!</small>
        </div>
      </li>
    </ul>
  </div>

  <!-- REQUIREMENTS -->
  <div class="card" id="requirementsSection">
    <h3>Upload Requirements</h3>

    <div class="req-item">
      <strong>Barangay Clearance</strong>
      <input type="file" onchange="uploadReq(this,'Barangay Clearance')">
      <div class="req-buttons"></div>
    </div>

    <div class="req-item">
      <strong>Certificate of Indigency</strong>
      <input type="file" onchange="uploadReq(this,'Certificate of Indigency')">
      <div class="req-buttons"></div>
    </div>

    <div class="req-item">
      <strong>Report Card</strong>
      <input type="file" onchange="uploadReq(this,'Report Card')">
      <div class="req-buttons"></div>
    </div>

    <div class="req-item">
      <strong>Birth Certificate</strong>
      <input type="file" onchange="uploadReq(this,'Birth Certificate')">
      <div class="req-buttons"></div>
    </div>

    <button id="submitBtn" onclick="submitRequirements()" disabled>
      Submit All Requirements
    </button>
  </div>

</div>

<!-- POPUP -->
<!-- POPUP -->
<div id="popup">
  <div class="popup-card">
    <h2>ðŸŽ‰ Congratulations!</h2>
    <p>You are now part of<strong>IskolarealeÃ±o</strong>!</p>
    <p style="margin-top: 15px; font-size: 14px; color: #6b7280;">
      Your scholar portal credentials have been sent to your email.<br>
      Please check your inbox for login instructions.
    </p>
    <button onclick="closePopup()">Continue</button>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ==============================
// CONFIG & STATE
// ==============================

const supabaseUrl = "https://wwzufquuogpshrlrofiv.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3enVmcXV1b2dwc2hybHJvZml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNTgxMzcsImV4cCI6MjA4MTYzNDEzN30.JXJgJEpX0BEKYHGbWH1zUq6lVv1jetg0AmEsM-HvZQs";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

const TOTAL_REQ = 4;

// Store uploaded file URLs locally
let requirements = {
  "Barangay Clearance": null,
  "Certificate of Indigency": null,
  "Report Card": null,
  "Birth Certificate": null
};

// ==============================
// TOGGLE REQUIREMENTS SECTION
// ==============================
function toggleRequirements() {
  const tracker = document.getElementById('trackerSection');
  const req = document.getElementById('requirementsSection');
  if (req.style.display === 'none' || req.style.display === '') {
    req.style.display = 'block';
    tracker.style.display = 'none';
  } else {
    req.style.display = 'none';
    tracker.style.display = 'block';
  }
}

// ==============================
// STATUS BAR (FIRST BOX)
// ==============================
function applyStatusUI(status) {
  const badge = document.getElementById("statusBadge");
  const fill = document.getElementById("progressFill");
  const percent = document.getElementById("progressPercent");

  const steps = {
    requirements_pending: 0,
    requirements_review: 25,
    requirements_approved: 40,
    exam_pending: 60,
    mswd_pending: 80,
    scholar: 100
  };

  const labels = {
    requirements_pending: "Upload Required Documents",
    requirements_review: "Requirements Under Review",
    requirements_approved: "âœ… Requirements Approved",
    exam_pending: "Examination Phase",
    mswd_pending: "MSWD Evaluation",
    scholar: "ðŸŽ‰ Scholar Accepted"
  };

  const progress = steps[status] ?? 0;
  fill.style.width = progress + "%";
  percent.innerText = progress + "%";
  badge.innerText = labels[status] ?? labels.requirements_pending;
}

// ==============================
// TRACKER UI (SECOND BOX)
// ==============================
// ==============================
// TRACKER UI (SECOND BOX)
// ==============================
function updateTrackerUI(status) {
  // Define steps in order
  const steps = [
    "requirements_pending",
    "requirements_review",
    "requirements_approved",
    "exam_pending",
    "mswd_pending",
    "scholar"
  ];

  steps.forEach((step) => {
    const stepElement = document.querySelector(`#tracker-${step}`);
    if (!stepElement) return;

    if (step === status) {
      stepElement.classList.add("current");
      stepElement.classList.remove("completed");
    } else if (steps.indexOf(step) < steps.indexOf(status)) {
      stepElement.classList.add("completed");
      stepElement.classList.remove("current");
    } else {
      stepElement.classList.remove("completed", "current");
    }
  });

  // ðŸŽ‰ Show popup if scholar status
  if (status === 'scholar') {
    setTimeout(() => {
      document.getElementById("popup").style.display = "flex";
    }, 500);
  }
}

// ==============================
// STATUS BAR (FIRST BOX)
// ==============================
function applyStatusUI(status) {
  const badge = document.getElementById("statusBadge");
  const fill = document.getElementById("progressFill");
  const percent = document.getElementById("progressPercent");

  const steps = {
    requirements_pending: 0,
    requirements_review: 25,
    requirements_approved: 40,
    exam_pending: 60,
    mswd_pending: 80,
    scholar: 100
  };

  const labels = {
    requirements_pending: "Upload Required Documents",
    requirements_review: "Requirements Under Review",
    requirements_approved: "âœ… Requirements Approved",
    exam_pending: "Examination Phase",
    mswd_pending: "MSWD Evaluation",
    scholar: "ðŸŽ‰ Scholar - Check your email for login credentials!"
  };

  const progress = steps[status] ?? 0;
  fill.style.width = progress + "%";
  percent.innerText = progress + "%";
  badge.innerText = labels[status] ?? labels.requirements_pending;

  // Change badge color for scholar status
  if (status === 'scholar') {
    badge.style.background = '#d1fae5';
    badge.style.color = '#065f46';
  }
}

// ==============================
// UPLOAD FILE
// ==============================

async function uploadReq(input, type) {
  if (!input || !input.files || !input.files[0]) return;

  const file = input.files[0];
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) return alert("You must be logged in");

  const form = new FormData();
  form.append("file", file);
  form.append("requirement_type", type);

  try {
    const res = await fetch("/api/requirements/upload", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + session.access_token
      },
      body: form
    });

    const data = await res.json();
    if (!data.success) {
      alert("Upload failed: " + data.error);
      return;
    }

    requirements[type] = data.file_url;

    const item = input.closest(".req-item");
    if (item) {
      item.classList.add("done");
      input.disabled = true;
    }

    renderRequirementButtons();
    updateSubmitButton();

  } catch (err) {
    alert("Upload error: " + err.message);
  }
}

// ==============================
// VIEW FILE
// ==============================
function viewFile(type) {
  const url = requirements[type];
  if (!url) {
    alert("No file uploaded yet!");
    return;
  }
  window.open(url, "_blank");
}

// ==============================
// DELETE FILE
// ==============================
async function deleteFile(type) {
  const token = localStorage.getItem("access_token");
  if (!token) return alert("You are not logged in");

  const res = await fetch(`/api/requirements/${encodeURIComponent(type)}`, {
    method: "DELETE",
    headers: {
      "Authorization": "Bearer " + token
    }
  });

  const data = await res.json();
  if (data.success) {
    requirements[type] = null;
    const item = Array.from(document.querySelectorAll(".req-item"))
      .find(i => i.querySelector("strong").innerText === type);
    if (item) {
      item.classList.remove("done");
      const input = item.querySelector("input");
      input.disabled = false;
      input.value = "";
    }
    renderRequirementButtons();
    updateSubmitButton();
  } else {
    alert("Delete failed: " + data.error);
  }
}

// ==============================
// SUBMIT ALL REQUIREMENTS
// ==============================
async function submitRequirements() {
  const token = localStorage.getItem("auth_token");
  if (!token) return alert("You are not logged in");

  const res = await fetch("/api/requirements/submit", {
    method: "POST",
    headers: {
      Authorization: "Bearer " + token,
      "Content-Type": "application/json"
    }
  });

  const data = await res.json();

  if (!data.success) {
    alert("Submit failed: " + data.error);
    return;
  }

  applyStatusUI("requirements_review");
  updateTrackerUI("requirements_review");
  alert("ðŸ“„ Documents submitted and under review");
}


// ==============================
// UPDATE SUBMIT BUTTON
// ==============================
function updateSubmitButton() {
  const uploadedCount = Object.values(requirements).filter(v => v).length;
  document.getElementById("submitBtn").disabled = uploadedCount !== TOTAL_REQ;
}

// ==============================
// RENDER REQUIREMENT BUTTONS
// ==============================
function renderRequirementButtons() {
  const items = document.querySelectorAll(".req-item");

  items.forEach(item => {
    const type = item.querySelector("strong").innerText;

    let container = item.querySelector(".req-buttons");
    if (!container) {
      container = document.createElement("div");
      container.className = "req-buttons";
      item.appendChild(container);
    }

    container.innerHTML = "";

    if (requirements[type]) {
      const viewBtn = document.createElement("button");
      viewBtn.innerText = "View";
      viewBtn.onclick = () => viewFile(type);

      const delBtn = document.createElement("button");
      delBtn.innerText = "Delete";
      delBtn.onclick = () => deleteFile(type);

      container.appendChild(viewBtn);
      container.appendChild(delBtn);
    }
  });
}

// ==============================
// LOAD APPLICATION STATUS
// ==============================
async function loadApplicationStatus() {
  const token = localStorage.getItem("access_token");
  if (!token) {
    console.log("No token found, skipping status load");
    return;
  }

  try {
    const res = await fetch("/api/application/status", {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();

    if (data.success && data.application_status) {
      console.log("Loaded status from database:", data.application_status);
      
      // Update both boxes with the saved status
      applyStatusUI(data.application_status);
      updateTrackerUI(data.application_status);
    } else {
      console.log("No application status found, using default");
      // Default to requirements_pending if no status exists
      applyStatusUI("requirements_pending");
      updateTrackerUI("requirements_pending");
    }
  } catch (err) {
    console.error("Failed to load application status:", err);
    // On error, show default state
    applyStatusUI("requirements_pending");
    updateTrackerUI("requirements_pending");
  }
}

// ==============================
// LOAD WELCOME NAME
// ==============================
async function loadWelcomeName() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) return;

  const res = await fetch("/api/applicant/profile", {
    headers: {
      Authorization: "Bearer " + session.access_token
    }
  });

  const data = await res.json();

  if (data.success && data.first_name) {
    document.getElementById("welcomeText").innerText =
      `Welcome, ${data.first_name}!`;
  }
}

// ==============================
// LOAD EXISTING REQUIREMENTS
// ==============================
async function loadRequirements() {
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (!session) return;

  try {
    const res = await fetch("/api/requirements", {
      method: "GET",
      headers: {
        Authorization: "Bearer " + session.access_token
      }
    });

    const data = await res.json();
    if (!data.success) return;

    // Reset first
    Object.keys(requirements).forEach(k => requirements[k] = null);

    data.files.forEach(f => {
      requirements[f.requirement_type] = f.file_url;
    });

    // Restore UI
    document.querySelectorAll(".req-item").forEach(item => {
      const type = item.querySelector("strong").innerText;
      const input = item.querySelector("input");

      if (requirements[type]) {
        item.classList.add("done");
        input.disabled = true;
      } else {
        item.classList.remove("done");
        input.disabled = false;
      }
    });

    renderRequirementButtons();
    updateSubmitButton();

  } catch (err) {
    console.error("Failed to load requirements:", err);
  }
}

// ==============================
// CLOSE POPUP
// ==============================
function closePopup() {
  document.getElementById("popup").style.display = "none";
}

// ==============================
// INITIALIZE ON PAGE LOAD
// ==============================
window.addEventListener("DOMContentLoaded", async () => {
  // Load welcome name
  await loadWelcomeName();
  
  // Load requirements
  await loadRequirements();
  
  // Load application status (this updates both boxes)
  await loadApplicationStatus();
});

</script>

</body>
</html>